# Эталонная реализация взаимодействия с модулем согласия на обработку (agree)

## Описание

Загрузка данных для регистрации пользователя под ID стороннего IDP согласно требованиям договора с провайдером ID/БДн -
потребителем сервисов ЕБС (вне требований 115 ФЗ).
Модуль тестировался с подписью типа *PLAIN*.
### Алгоритм работы модуля

1. На вход при запуске модуля в качестве аргументов передаются два значения: путь к конфигурации логирования и путь к
   JSON-файлу, содержащему набор конфигураций, переданных пользователем. Конфигурационный файл имеет следующую
   структуру.

```json
{
  "general_data": {
    "need_generate_token": "{true - формируем JWT, на основе переданных данных, false - используем готовый JWT} - Обязательно",
    "service_url": "{Адрес agree сервиса} - обязательно. Пример: http://agree-server.tech",
    "registration_path": "/api/v1/registration"
  },
  "crypto_config": {
    "container_type": "HDIMAGE",
    "key_id": "1111111-1111-1111-1111-11111111",
    "password": "1234567890",
    "algorithm": "GOST3411_2012_256withGOST3410_2012_256"
  },
  "headers_data": {
    "typ": "JWT",
    "alg": "GOST3410_2012_256{Или другой, приведённый в разделе 'Доступные типы подписи'}"
  },
  "existing_jwt": {
    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
  },
  "payload_data": {
    "crypto_url": "{Адрес сервиса для формирования JWT} - обязательно. Пример: http://sign.test ",
    "service_type": "{Тип (мнемоника) услуги} - обязательно. Пример: reg_without_bio",
    "datetime_tz": "{Дата регистрации (Формат Unix timestamp в секундах)} - обязательно. Пример: 1589277386",
    "infosystem": {
      "system_id": "{Мнемоника ИС Контрагента} - обязательно. Пример: XXX ",
      "contract_id": "{Идентификатор контракта} - обязательно. Пример: 24341534",
      "cert_id": "{Идентификатор центра обслуживания в реестре поставщика идентификации IDP} - обязательно. Пример: 4363463463223787800",
      "employee_id": "{Сотрудник, осуществляющий регистрацию}",
      "ra_id": "{Идентификатор центра обслуживания в реестре поставщика идентификации IDP}. Пример: 748347"
    },
    "agree": {
      "date_from": "{Дата c которой действует согласие (Формат Unix timestamp в секундах)}. Пример: 1589277386",
      "agreement_id": "{Идентификатор записи данных согласия в ИС КА. Если согласие для ИС КА получает ЕБС, то заполняется идентификатор согласия в ЕБС}. Пример: 12345678910-agreeID",
      "date_to": "{Дата до которой действует согласие (Формат Unix timestamp в секундах))}. Пример: 1683868229"
    },
    "person": {
      "idp": "{Идентификатор (мнемоника) IDP} - обязательно. Пример: IDP_TESTSYSTEM",
      "user_id": "{ID УЗ пользователя IDP} - обязательно. Пример: 1",
      "contact": {
        "email": "{Электронная почта пользователя}. Пример: test-email@mail.ru",
        "phone": "{Телефон пользователя, указывается в формате +7XXXXXXXXXX, где X цифра от 0 до 9}"
      }
    },
    "matching": [
      {
        "key": "{Описание передаваемых данных для мэтчинга} - обязательно. Пример: ESIA",
        "value": "{Значения данных для мэтчинга (Хеш ПДн или ID УЗ пользователя IDP)} - обязательно. Пример: 1111111111"
      }
    ],
    "metrics": {
      "Ключ": "Значение"
    },
    "meta": {
      "Ключ": "Значение"
    }
  }
}
```

2. Конфигурационный файл парсится в объект AgreeConfig.
3. Если передано значение `true` в `need_generate_token` конфигурационного файла, тогда формируется JWT на основе
   данных, переданных в `headers_data` и `payload_data`, после чего токен подписывается на основе данных в
   блоке `crypto_config`. Если же было передано значение false в `need_generate_token`, то используется JWT, переданный
   в блоке `existing_jwt`.
4. Сервис отправляет [запрос](#Описание-запросов) с JWT, описанном в п.3, и в случае успешного выполнения запроса
   возвращается HTTP-ответ 202 Accepted, в теле ответа указывается идентификатор запроса, в противном случае
   возвращается код ошибки и описание, что пошло не так. Полученный ответ логируется в консоли.

# Описание запросов

## Registration (регистрация без биометрии)

**Описание**: Регистрация без биометрии.

**Вызов сервиса**: POST `/api/v1/registration`

### Входные параметры

### Тело запроса

Заголовки запроса:

    Content-Type: multipart/form-data

Часть multipart для передачи JWT

| Наименование параметра | Тип данных | Обязательность | Описание      |
|------------------------|------------|----------------|---------------|
| params                 | String     | да             | Содержит JWT. |

Входные параметры:
Передаются в формате JWT токена. Jwt формируется и подписываются Контрагентом. Данный JWT токен состоит из трёх частей,
разделённых точкой, и имеет следующий вид:
HEADER.PAYLOAD.SIGNATURE. Каждая из частей токена представляет собой Base64url Encoding значение. HEADER – описание
свойств токена, в том числе описание используемого алгоритма для подписи; PAYLOAD – непосредственно данные; SIGNATURE -
подпись запроса (запрос должен быть подписан PKCS#7 (cert + Sig), закодированный в формате Base64)

**Пример Headers для JWT:**

```json
{
  "typ": "JWT",
  "alg": "GOST3410_2012_256"
}
```

**Доступные значения параметра alg:**

| Алгоритмы, указываемые в header alg| Описание |
|------------------------|------------|
| GOST3410_2012_256                 | алгоритм GOST3411_2012_256withGOST3410_2012_256     |
| GOST3410_2012_512                 | алгоритм GOST3411_2012_512withGOST3410_2012_256     |

**Доступные типы подписи:**

| Тип подписи| Описание |
|--------------------------|-------------------------------------------------------|
| PKCS7 attached signature | Подпись стандарта PKCS# 7. Содержит следующие атрибуты: <br> Подпись (Attached); <br> Набор обязательных подписываемых атрибутов <br> (CONTENT_TYPE (1.2.840.113549.1.9.3), SIGNING_TIME <br> (1.2.840.113549.1.9.5), MESSAGE_DIGEST <br> (1.2.840.113549.1.9.4)); <br> Дополнительные атрибуты (data (1.2.840.113549.1.7.1), <br> идентификатор алгоритма хэширования и <br> сертификаты подписантов). |
| PKCS7 detached signature | Подпись стандарта PKCS7 (RFC2315). Содержит<br> следующие атрибуты:<br> Подпись (Detached); <br> Набор обязательных подписываемых атрибутов<br> (CONTENT_TYPE (1.2.840.113549.1.9.3), SIGNING_TIME <br> (1.2.840.113549.1.9.5), MESSAGE_DIGEST |<br> (1.2.840.113549.1.9.4)); <br> Дополнительные атрибуты (идентификатор <br> алгоритма хэширования, сертификаты подписантов <br> (вместе с корневыми сертификатами) и открытый <br> ключ (по идентификатору, соответствующему <br> алгоритму подписания)).|

**Структура payload**

| Наименование параметра  | Тип данных         | Обязательность | Описание                                                                                                              |
|-------------------------|--------------------|----------------|-----------------------------------------------------------------------------------------------------------------------|
| service_type            | String             | да             | Тип (мнемоника) услуги.                                                                                               |
| datetime_tz             | Number             | да             | Дата регистрации (Формат Unix timestamp в секундах).                                                                  |
| infosystem              | JSON-OBJECT        | да             | Содержит информацию о ИС Контрагента, отправившей запрос.                                                             |
| infosystem.system_id    | String             | да             | Мнемоника ИС Контрагента.                                                                                             |
| infosystem.contract_id  | String             | да             | Идентификатор контракта.                                                                                              |
| infosystem.ra_id        | String             | нет            | Идентификатор центра обслуживания в реестре поставщика идентификации IDP.                                             |
| infosystem.employee_id  | String             | нет            | Сотрудник, осуществляющий регистрацию.                                                                                |
| infosystem.cert_id      | String             | да             | id сертификата, которым подписана JWT (сертификаты хранятся в реестре сертификатов в привязке к мнемонике ИС_Поставщика БДн). |
| agree                   | JSON-OBJECT        | нет            | Содержит информацию о согласии).                                                                                      |
| agree.agreement_id      | String             | нет            | Идентификатор записи данных согласия в ИС КА. Если согласие для ИС КА получает ЕБС, то заполняется идентификатор согласия в ЕБС. |
| agree.date_from         | Number             | да             | Дата c которой действует согласие (Формат Unix timestamp в секундах)                                                  |
| agree.date_to           | Number             | нет            | Дата до которой действует согласие (Формат Unix timestamp в секундах)                                                 |
| person                  | JSON-OBJECT        | да             | Содержит информацию о пользователе                                                                                    |
| person.idp              | String             | да             | Идентификатор (мнемоника) IDP                                                                                         |
| person.user_id          | String             | да             | ID УЗ пользователя IDP                                                                                                |
| person.contact          | JSON-OBJECT        | нет            | Контактные данные пользователя                                                                                        |
| person.contact.phone    | String             | нет            | Телефон пользователя, указывается вформате +7XXXXXXXXXX, где X цифра от 0 до 9                                                                                        |
| person.contact.email    | String             | нет            | Электронная почта пользователя                                                                                        |
| matching                | ARRAY[]            | да             | Содержит данные для мэтчинга                                                                                        |
| matching.key            | String             | да             | Описание передаваемых данных для мэтчинга.                                                                                           |
| matching.value          | String             | да            | Значения данных для мэтчинга (Хеш ПДн или ID УЗ пользователя IDP).                                                                                                          |
| meta                    | JSON-OBJECT        | нет            | Дополнительные метаданные (согласно спецификации, более подробно см. постановку)                                                                                    |
| metrics                    | JSON-OBJECT        | нет            | Дополнительные данные о метриках системы (согласно спецификации, более подробно см. постановку).                                                                                      |

Пример запроса:

```bash
curl -XPOST -v http://localhost:8092/api/v1/registration -F params= eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

**Ответ**:

В случае успешного ответа, метод возвращает HTTP-ответ с кодом 202 Accepted с содержимым в формате application/json в
кодировке UTF-8. В HTTP BODY включен идентификатор запроса.

```json
{
  "request_id": "111111111111111"
}
```

В случае возникновения ошибки при обработке запроса, Система возвращает вызывающей стороне коды ответов HTTP и описания
ошибок в HTTP BODY.

| Код ответа HTTP | Значение параметра "code" | Описание (параметр «message») |
|------------------------|------------|----------------|
| 400 | EBS-010003 |Неверный запрос. {описание ошибки} |
| 400 | EBS-010004 |Запрос не содержит обязательного параметра {название параметра} |
|403 | EBS-02030 |Отказано в доступе. Указанный провайдер идентификации отсутствует в системе |
| 403 | EBS-02031 |Отказано в доступе. Указанный провайдер идентификации заблокирован в системе |
| 403 | EBS-02040 |Отказано в доступе. Указанная ИС отсутствует в системе |
| 403 | EBS-02041 |Отказано в доступе. Указанная ИС заблокирована в системе |
| 500 | EBS-010001 |Внутренняя ошибка API |
| 500 | EBS-010002 |Сервис в настоящее время не может выполнить запрос из-за большой нагрузки или технических работ на сервере |

# Сборка jar и запуск

Из-за особенностей работы с cryptopro необходимо собирать jar без зависимостей.

Для сборки jar необходимо выполнить:

```bash
./gradlew build
```

Для сборки зависимостей проекта необходимо вызвать команду:

```bash
./gradlew copyRuntimeDependencies
```

Для запуска необходима специальная настройка стенда и java csp, для работы с cryptopro. Пример команды запуска проекта:

```bash
java -cp clients/agree/build/libs/agree-1.0.1.<hash>.jar:/home/java-csp-5.0.40424/*:clients/agree/build/jars/* ru.rtlabs.ebs.agree.AgreeMain -c clients/agree/src/main/resources/general-properties.json -l clients/agree/src/main/resources/logback.xml
```

`<hash>` - фрагмент версии, обозначающий текущее положение в системе контроля версий.

`logback.xml` - конфигурация логирования.

`general-properties.json` - конфигурация для модуля.


