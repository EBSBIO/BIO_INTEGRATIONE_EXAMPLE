# Эталонная реализация взаимодействия с модулем верификации (pdp) ЕБС.

## Описание

Проект является примером реализации верификации пользователя в ЕБС. Данный проект предназначен для выполнения
верификации с пассивными лайвнес
[мнемониками](#Таблица-мнемоник-верификации). Также проект может работать с активным лайвнес, с заранее заготовленными
данными.

На текущий момент модуль настроен для работы с модальностью - фото. Модуль тестировался с подписью типа *PLAIN*.

## Таблица мнемоник верификации

| Мнемоника                                             | Face | Voice | Active Liveness | Passive Liveness | outer web | Fz 115 web | web photo | web sound | multipart photo | multipart audio | multipart video |
|-------------------------------------------------------|------|-------|-----------------|------------------|-----------|------------|-----------|-----------|-----------------|-----------------|-----------------|
| FZ_115                                                | 1    | 1     | 1               | 0                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| FZ_115_with_passive_liveness                          | 1    | 1     | 1               | 1                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| FZ_115_without_webinterface                           | 1    | 1     | 1               | 0                | 0         | 0          | 0         | 0         | 0               | 0               | 1               |
| face_only                                             | 1    | 0     | 0               | 0                | 1         | 0          | 0         | 0         | 1               | 0               | 0               |
| voice_only                                            | 0    | 1     | 0               | 0                | 1         | 0          | 0         | 0         | 0               | 1               | 0               |
| face_only_with_webinterface                           | 1    | 0     | 0               | 0                | 0         | 0          | 1         | 0         | 1               | 0               | 0               |
| voice_only_with_webinterface                          | 0    | 1     | 0               | 0                | 0         | 0          | 0         | 1         | 0               | 1               | 0               |
| face_with_passive_liveness                            | 1    | 0     | 0               | 1                | 1         | 0          | 0         | 0         | 1               | 0               | 0               |
| voice_with_passive_liveness                           | 0    | 1     | 0               | 1                | 1         | 0          | 0         | 0         | 0               | 1               | 0               |
| face_with_passive_liveness_and_webinterface           | 1    | 0     | 0               | 1                | 0         | 0          | 1         | 0         | 1               | 0               | 0               |
| voice_with_passive_liveness_and_webinterface          | 0    | 1     | 0               | 1                | 0         | 0          | 0         | 1         | 0               | 1               | 0               |
| face_with_active_liveness                             | 1    | 0     | 1               | 0                | 1         | 0          | 0         | 0         | 0               | 0               | 1               |
| voice_with_active_liveness                            | 0    | 1     | 1               | 0                | 1         | 0          | 0         | 0         | 0               | 0               | 1               |
| face_with_active_liveness_and_webinterface            | 1    | 0     | 1               | 0                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| voice_with_active_liveness_and_webinterface           | 0    | 1     | 1               | 0                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| face_with_all_liveness                                | 1    | 0     | 1               | 1                | 1         | 0          | 0         | 0         | 0               | 0               | 1               |
| voice_with_all_liveness                               | 0    | 1     | 1               | 1                | 1         | 0          | 0         | 0         | 0               | 0               | 1               |
| face_with_all_liveness_and_webinterface               | 1    | 0     | 1               | 1                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| voice_with_all_liveness_and_webinterface              | 0    | 1     | 1               | 1                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| face_and_voice_only                                   | 1    | 1     | 0               | 0                | 1         | 0          | 0         | 0         | 1               | 1               | 0               |
| face_and_voice_only_with_webinterface                 | 1    | 1     | 0               | 0                | 0         | 0          | 1         | 1         | 1               | 1               | 0               |
| face_and_voice_with_passive_liveness                  | 1    | 1     | 0               | 1                | 1         | 0          | 0         | 0         | 1               | 1               | 0               |
| face_and_voice_with_passive_liveness_and_webinterface | 1    | 1     | 0               | 1                | 0         | 0          | 1         | 1         | 1               | 1               | 0               |
| face_and_voice_with_active_liveness                   | 1    | 1     | 1               | 0                | 1         | 0          | 0         | 0         | 0               | 0               | 1               |
| face_and_voice_with_active_liveness_and_webinterface  | 1    | 1     | 1               | 0                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |
| face_and_voice_with_all_liveness                      | 1    | 1     | 1               | 1                | 1         | 0          | 0         | 0         | 0               | 0               | 1               |
| face_and_voice_with_all_liveness_and_webinterface     | 1    | 1     | 1               | 1                | 0         | 1          | 0         | 0         | 0               | 0               | 1               |

## Конфигурация проекта

[Конфигурация](/src/main/java/ru/rtlabs/ebs/reference/receiver/client/verification/config/VerificationConfig.java)
проекта состоит из нескольких частей:

- crypto_config
    - [конфигурация для работы с сервисом подписания](../../libs/configurations/src/main/java/ru/rtlabs/ebs/reference/receiver/configurations/crypto/CryptoConfig.java)
- ebs_config
    - [конфигурация для работы с ЕБС](/src/main/java/ru/rtlabs/ebs/reference/receiver/client/verification/config/ebs/EbsConfig.java)
- is_generate_jwt - флаг на формирование jwt из данных в конфигурации посредством сервиса шифрования.

Модуль может как использовать готовый jwt, без обращения в сервис подписания, если стоит is_generate_jwt - false, так и
создавать и подписывать jwt сам, если is_generate_jwt - true.

Верификация пользователя выполняется в 3 этапа при пассивном лайвнесе и 4 этапа при активном:

1. [Выполнение запроса на создание сессии](#Выполнение-запроса-на-создание-сессии).
2. [Выполнение запроса на получение инструкций](#Выполнение-запроса-на-получение-инструкций) *(только активный лайвнес)*
3. [Выполнение запроса на загрузку БО](#Выполнение-запроса-на-загрузку-БО).
4. [Выполнение запроса на получение расширенного результата верификации](#Выполнение-запроса-на-получение-расширенного-результата-верификации)

### Выполнение запроса на создание сессии

*POST /api/v3/verifications?redirect={redirect_uri}*

Для выполнения запроса на создание сессии модуль получает данные
из [конфигурации](/src/main/java/ru/rtlabs/ebs/reference/receiver/client/verification/config/ebs/CreateSession.java)

Перед выполнением запроса модуль генерирует идентификатор сессии, для всех последующих запросов этот идентификатор
сессии будет необходим.

#### Заголовки:

* Host: {host ГИС ЕБС}
* Content-Type: application/json
* X-EBS-TraceProcess: true (необязательный заголовок, необходимый для проверки взаимодействия с использованием
  Технологического портала)
* Authorization: Bearer {JWT от провайдера идентификации, сформированный в соответствии с RFC
  7519 https://datatracker.ietf.org/doc/html/rfc7519}
* Cache-Control: no-cache

Каждая из частей токена представляет собой значение, закодированное в URL safe Base64:

* JWT.HEADER - описание свойств токена, в том числе описание используемого алгоритма для подписи;
* JWT.PAYLOAD - содержимое токена;
* JWT.SIGNATURE - подпись запроса.

#### Параметры запроса:

| Наименование параметра | Тип данных  | Обязательность | Описание                                                                                                                                 |
|------------------------|-------------|----------------|------------------------------------------------------------------------------------------------------------------------------------------|
| redirect               | string      | нет            | Передается в виде query-параметра в строке запроса                                                                                       |
| metadata               | JSON Object | да             | Передается в теле запроса. Содержит перечень дополнительных данных <<metadata,согласно спецификации объекта metadata>>.                  |
| bio_collecting_type    | String      | да             | Требуемая мнемоника согласованной схемы сбора БО. Возможные значения и соответствующие им параметры описаны в <<mnemonics,таблице ниже>>. |

Формат параметра metadata: date, должен соответствовать формату даты в составе маркера доступа, переданного в Систему в
составе запроса метода «Старт верификации в ЕБС».

| Наименование параметра | Описание                                                                                                                                          | Формат                                                    | Пример                               |
|------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|--------------------------------------|
| date                   | Дата и время начала операции (формирования запроса клиентом)                                                                                      | timestamp                                                 | 1520467814933                        |
| time_zone              | Временная зона: Год, Месяц, День, Часы, Минуты, Секунды, Временная зона                                                                           | yyyy-MM-dd'T'HH:mm:ss.SSSZ                                | 2018-03-30T17:30:09.453+0500         |
| geolocation            | Координаты (Геолокация): широта и долгота                                                                                                         | latitude;longitude                                        | 51.7556415;55.1028652                |
| rooted                 | Наличие jailbreak или root-доступа в операционной системе                                                                                         | true/false                                                | true                                 |
| operating_system       | Операционная система устройства: название, версия                                                                                                 | name version                                              | Android 6.0.1                        |
| isp                    | Провайдер                                                                                                                                         | name                                                      | MegaFon                              |
| advertising_id         | Идентификатор рекламы устройства (AdID в Android и IDFA в iOS)                                                                                    | value                                                     | 38400000-8cf0-11bd-b23e-10b96e40000d |
| screen                 | Разрешение экрана                                                                                                                                 | width;height                                              | 1200;1920                            |
| dpi                    | Плотность экрана устройства - значение, единицы измерения плотности пикселей                                                                      | value                                                     | 320 Dpi                              |
| camera_id              | Идентификатор камеры                                                                                                                              | name                                                      | 2                                    |
| locale                 | Региональные настройки (локаль): страна, язык, название временной зоны. Данный параметр зависит от устройства и выбранных пользователем настроек. | country;language;timezonename                             | RU;ru;Москва, стандартное время      |
| device_serial          | Серийный номер мобильного устройства.                                                                                                             | deviceNumber                                              | 0819da27                             |
| imei                   | IMEI - международный идентификатор мобильного оборудования                                                                                        | value                                                     | 357719051789508                      |
| device_id              | Уникальный идентификатор Android-устройства                                                                                                       | value                                                     | d1b23eв2f3b480сb                     |
| device_manufacturer    | Производитель устройства                                                                                                                          | name                                                      | asus                                 |
| device_model           | Модель устройства                                                                                                                                 | name                                                      | Nexus 7                              |
| device_cpu             | Информация о процессоре устройства                                                                                                                | value                                                     | ARMv7 Processor rev 0 (v7l)          |
| sim                    | Информация о SIM-карте: оператор; название оператора; страна; номер сим карты. Можно отдавать раздельно.                                          | simOperator;simOperatorName;simCountryIso;simSerialNumber | 25002;MegaFon;ru;897210285241754519  |

#### Пример запроса

```shell
POST /api/v3/verifications?redirect=https%3A%2F%2Ftest.client.local%2F HTTP/1.1
Host: ebs.rtlabs.ru
Content-Type: application/json
X-EBS-TraceProcess: true
ebs.session: D530D7AF1EFA47489653FC4CEA5AC625
Authorization: Bearer {JWT от IDP}
Cache-Control: no-cache
  
{
    "metadata":{
        "date":"1520467814933"
    },
    "bio_collecting_type":"face_only"
}
```

#### Набор обязательных полей:

- Jwt в заголовке запроса. В качестве jwt подразумевается как jwt от ЕСИА, так и jwt формата ЕБС для других idp.
- json в теле запроса, содержащий метаданные и мнемонику верификации (bio_collecting_type). Поле metadata.date -
  обязательное, bio_collecting_type - обязательное
- поле redirect в параметрах запроса обязательно ТОЛЬКО в случае, если мнемоника верификации подразумевает использование
  web-интерфейсов ЕБС.

#### *Успешный ответ*

В случае успешного ответа, метод возвращает НТТР-код 200 OK со следующими заголовками:

* Location - содержит URL веб-формы ЕБС, на который Потребитель БДн осуществит перенаправление пользователя для снятия
  биометрических образцов, в случае, если это необходимо (в составе URL присутствует в виде параметра адрес redirect,
  полученный в запросе);
* Session-Id - идентификатор сессии верификации в ЕБС.

#### Пример успешного ответа

```shell
HTTP/1.1 200 OK
Location: https://ebs.rtlabs.ru/ui/verification?redirect=https%3A%2F%2Ftest.client.local%2F
Session-Id: D530D7AF1EFA47489653FC4CEA5AC625
```

#### *Ошибки метода*

В случае возникновения ошибки при обработке запроса, система возвращает вызывающей стороне коды ответов HTTP и описания
ошибок в HTTP BODY, согласно таблице ниже.

| Код HTTP ответа | Значение параметра "code" | Описание (параметр "message")                              |
|-----------------|---------------------------|------------------------------------------------------------|
| 400             | EBS-010301                | Пользователь не найден                                     |
| 403             | EBS-010109                | Провайдеру идентификации (IDP) запрещен доступ к ЕБС       |
| 403             | EBS-010203                | Системе-клиенту (ИС Потребителя БДн) запрещен доступ к ЕБС |
| 403             | EBS-010110                | Пользователю запрещен доступ к ЕБС                         |

#### Пример ответа с ошибкой

```shell
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=UTF-8

{
"code": "EBS-010301",
"message": "Пользователь не найден"
}
```

### Выполнение запроса на получение инструкций

Данный запрос необходим *только* при активном liveness

*POST /api/v3/verifications/{session_id}/negotiate*

где: {session_id} - идентификатор сессии верификации в ЕБС, полученный в ответе
метода [«Выполнение запроса на создание сессии»](#Выполнение-запроса-на-создание-сессии).

Заголовки:

* Host: {host ГИС ЕБС}
* User-Agent: {тип и характеристики ПО}
* X-EBS-TraceProcess: true (необязательный заголовок, необходимый для проверки взаимодействия с использованием
  Технологического портала)
* Client-Type: {тип клиента}
* Accept: application/json
* Content-Type: application/json
* Cache-Control: no-cache

Тело запроса содержит обязательный JSON-объект metadata

| Наименование параметра | Тип данных  | Обязательность | Описание                                                                                                                                 |
|------------------------|-------------|----------------|------------------------------------------------------------------------------------------------------------------------------------------|
| metadata               | JSON Object | да             | Передается в теле запроса. Содержит перечень дополнительных данных <<metadata,согласно спецификации объекта metadata>>.                  |

#### Пример запроса

```shell
POST /api/v3/verifications/D530D7AF1EFA47489653FC4CEA5AC625/negotiate HTTP/1.1
Host: ebs.rtlabs.ru
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.3
X-EBS-TraceProcess: true
Client-Type: application/vnd.ebs.v1.mobile.android+json
Accept: application/json
Content-Type: application/json
Cache-Control: no-cache
{
    "metadata":{
        "camera_id":"2",
        "screen":"1200;1920",
        "device_number":"0819da27",
        "date":"1520467814933"
    }
}
```

#### *Успешный ответ*

В случае успешного ответа, метод возвращает сообщение, содержащее следующие параметры:

| Наименование параметра   | Тип данных  | Обязательность | Описание                                                                                                                                                                       |
|--------------------------|-------------|----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| liveness_action          | JSON Object | да             | Содержит мнемонику согласованной схемы проверки Liveness и объект–описание необходимых действий метода на стороне клиентского приложения                                       | 
| liveness_action.mnemonic | String      | да             | Мнемоника согласованной схемы проверки Liveness                                                                                                                                | 
| liveness_action.index    | String      | да             | Указание очередности в запросе согласованной схемы проверки Liveness                                                                                                           | 
| liveness_action.actions  | JSON Object | да             | Содержит перечень необходимых действий метода проверки Liveness на стороне клиентского приложения                                                                              | 
| actions.type             | String      | да             | Описание исполняемого Пользователем действия                                                                                                                                   | 
| actions.index            | String      | да             | Указание очередности в запросе исполняемого Пользователем действия                                                                                                             | 
| actions.duration         | String      | да             | Время отображения действия Пользователю (в миллисекундах)                                                                                                                      | 
| actions.message          | String      | да             | Инструкция, описывающая действие, предлагаемое к совершению Пользователем                                                                                                      | 
| actions.text             | String      | нет            | Содержит кодовую последовательность (в данном случае для действия «numbers-digits»: неповторяющиеся цифры от 0 до 9) в текстовой форме, предлагаемую к прочтению Пользователем | 

#### Пример успешного ответа

```shell
HTTP/1.1 200 OK
Content-Type: application/json; charset=UTF-8
{
    "liveness _action": [{
            "mnemonic":"move-instructions",
            "index":0,
            "actions":[{
                "type":"BLINK",
                "index":0,
                "duration":7000,
                "message":"Пожалуйста, моргните"
                },
                {
                "type":"SMILE",
                "index":1,
                "duration":7000,
                "message":"Пожалуйста, улыбнитесь"
                }]
            },
            {
            "mnemonic":"text-instructions",
            "index":1,
            "actions":[{
                "type":"numbers-digits",
                "index":0,
                "duration":7000,
                "message":"Произнесите цифры:",
                "text":"один два три четыре пять"
            }]
        }]
}
```

#### *Ошибки метода*

В случае возникновения ошибки при обработке запроса, ЕБС возвращает вызывающей стороне коды ответов HTTP и описания
ошибок в HTTP BODY, согласно таблице ниже.

| Код HTTP ответа | Значение параметра "code" | Описание (параметр "message")  |
|-----------------|---------------------------|--------------------------------|
| 400             | EBS-010302                | Идентификатор сессии не найден |
| 400             | EBS-010303                | Время жизни сессии истекло     |

#### Пример ответа с ошибкой

```shell
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=UTF-8
   
{
  "code": "EBS-010302",
  "message": "Идентификатор сессии не найден"
}
```

### Выполнение запроса на загрузку БО

*POST /api/v3/verifications/{session_id}/upload*

где: {session_id} - идентификатор сессии верификации в ЕБС, полученный в ответе метода «Старт верификации в ЕБС»

Заголовки:

* Host: {host ГИС ЕБС}
* Content-Type: multipart/form-data; boundary={разделитель}
* User-Agent: {тип и характеристики ПО}
* X-EBS-TraceProcess: true (необязательный заголовок, необходимый для проверки взаимодействия с использованием
  Технологического портала)
* Client-Type: {тип клиента}
* Accept: application/json
* Cache-Control: no-cache

Заголовки вложенных сущностей:

* Content-Disposition: form-data; name={название содержимого}
* Content-Type: {тип содержимого по MIME}

Параметры запроса

| Наименование параметра   | Тип данных      | Обязательность | Описание                                                                                                                                                                                                                       |
|--------------------------|-----------------|----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| bs_<мнемоника>           | Части multipart | да             | Содержит биометрические образцы для извлечения БШ. Допустимые Content-Type: video/mp4; video/mov; image/jpeg; image/png; audio/wav; name="bs_photo", "bs_audio", "bs_video" (в соответствии с заданной мнемоникой верификации) |
| liveness_action          | Часть multipart | нет            | Часть multipart для передачи описания применённого метода обнаружения живучести. Content-Type: application/json                                                                                                                |
| liveness_action.mnemonic | String          | да             | Содержит мнемоники согласованных схем проверки Liveness                                                                                                                                                                        |
| liveness_action.index    | String          | да             | Содержит указание очередности в запросе согласованной схемы проверки Liveness                                                                                                                                                  |
| liveness_action.actions  | JSON-object     | да             | Содержит перечень необходимых действий метода проверки Liveness на стороне клиентского приложения, исполненных Пользователем                                                                                                    |
| actions.type             | String          | да             | Мнемоника исполняемого Пользователем действия. Content-Type: application/json.                                                                                                                                                 |
| actions.index            | String          | да             | Содержит указание очередности в запросе исполняемого Пользователем действия                                                                                                                                                    |
| actions.duration         | String          | да             | Содержит время отображения действия Пользователю (в миллисекундах)                                                                                                                                                             |
| actions.client_duration  | String          | да             | Содержит фактическое время исполнения действия Пользователем (в миллисекундах)                                                                                                                                                 |
| actions.message          | String          | да             | Содержит инструкцию, описывающую действие, предлагаемое к совершению Пользователем                                                                                                                                             |
| metadata                 | Часть multipart | да             | Содержит дополнительные данные (согласно <<metadata,Спецификации параметров metadata>>). Content-Type: application/json                                                                                                        |

```shell
POST /api/v3/verifications/D530D7AF1EFA47489653FC4CEA5AC625/upload HTTP/1.1
Host: ebs.rtlabs.ru
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.3
X-EBS-TraceProcess: true
Client-Type: application/vnd.ebs.v1.mobile.android+json
Accept: application/json
Cache-Control: no-cache
  
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="bs_photo"
Content-Type: image/jpeg
   
{Поток байт Биометрического образца}
  
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="metadata"
Content-Type: application/json
  
 {
        "camera_id":"2",
        "screen":"1200;1920",
        "device_number":"0819da27",
        "date":"1520467814933"
   }
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

#### *Успешный ответ*

В случае успешного прохождения верификации, метод возвращает НТТР-код 200 OK.

В HTTP заголовке «Location» содержится URL ИС Потребителя БДн, для перенаправления пользователя после успешной
верификации. ГИС ЕБС использует значение URL ИС Потребителя БДн, переданное в параметре «redirect» при вызове метода
«Старт верификации в ЕБС».

Дополнительно в виде заголовков передаются параметры, приведенные в таблице:

| Наименование параметра | Тип данных | Обязательность | Описание                                                                                                                                                                                                                                                                                                                                                                                          |
|------------------------|------------|----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| verify_token           | String     | да             | Контрольное значение (уникальный идентификатор, созданный ГИС ЕБС), необходимое для получения расширенного результата верификации после успешной верификации. Передается в составе HTTP заголовка "Verification-Token"                                                                                                                                                                            |
| expired                | Number     | да             | Время прекращения действия результата биометрической верификации пользователя в ЕБС, в миллисекундах с 1 января 1970 г. 00:00:00 GMT. Передается в дополнительном HTTP заголовке "Session-Expires". После указанного в параметре момента времени получение расширенного результата верификации в ЕБС будет невозможно. Может быть уникальным для IDP. По умолчанию принимается равным 15 минутам. |

#### Пример успешного ответа

```shell
HTTP/1.1 200 OK
Location: https://test.client.local/return_uri
Verification-Token:0BCAF243SE9CF4F607E3CEB7EE416D031
Session-Expires:1499443407648
```

#### *Ошибки метода*

В случае возникновения ошибки при обработке запроса, перенаправления на указанную при старте верификации страницу
внешней инфосистемы не произойдет. ГИС ЕБС вернет вызывающей стороне код ответа HTTP и описание ошибки в HTTP BODY,
согласно таблице ниже.

| Код HTTP ответа | Значение параметра "code" | Описание (параметр "message")                                                                                                                                                        |
|-----------------|---------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 400             | EBS-010105                | Биометрический образец отсутствует                                                                                                                                                   |
| 400             | EBS-010107                | Не удалось извлечь биометрические признаки                                                                                                                                           |
| 400             | EBS-010108                | Ошибка верификации (биометрическая верификация не пройдена)                                                                                                                          |
| 400             | EBS-010115                | Неверный формат метаданных. Данная ошибка отдается так же в случае, если в запросе получен mime-type невалидного формата или mime-type не соответствует модальности передаваемого БО |
| 400             | EBS-010302                | Идентификатор сессии не найден                                                                                                                                                       |
| 400             | EBS-010303                | Время жизни сессии истекло                                                                                                                                                           |
| 403             | EBS-010111                | Не верный формат действий (описание действий не совпадают с отправленными)                                                                                                           |

#### Пример ответа с ошибкой

```shell
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=UTF-8
    
{
  "code": "EBS-010108",
  "message": "Ошибка верификации"
}
```

### Выполнение запроса на получение расширенного результата верификации

*GET /api/v3/verifications/{session_id}/result*

где: {session_id} – идентификатор сессии верификации в ГИС ЕБС, полученный в ответе метода «Старт верификации в ЕБС».

Заголовки:

* Host: {host ГИС ЕБС}
* X-EBS-TraceProcess: true (необязательный заголовок, необходимый для проверки взаимодействия с использованием
  Технологического портала)
* Authorization: Bearer {JWT токен от провайдера идентификации, сформированный в соответствии с RFC
  7519 https://datatracker.ietf.org/doc/html/rfc7519}
* Cache-Control: no-cache

JWT состоит из трёх частей, разделённых точкой, и имеет следующий вид: HEADER.PAYLOAD.SIGNATURE. Каждая из частей токена
представляет собой значение, закодированное в URL safe Base64.

Каждая из частей токена представляет собой значение, закодированное в URL safe Base64:

* JWT.HEADER - описание свойств токена, в том числе описание используемого алгоритма для подписи;
* JWT.PAYLOAD - содержимое токена;
* JWT.SIGNATURE - подпись запроса.

```shell
{
    GET /api/v3/verifications/D530D7AF1EFA47489653FC4CEA5AC625/result HTTP/1.1
	Host: ebs.rtlabs.ru
	X-EBS-TraceProcess: true
	Authorization: Bearer {JWT токен}
	Cache-Control: no-cache
}
```

#### *Успешный ответ*

В случае успешного ответа, метод возвращает HTTP-код 200 OK, а также тело ответа следующего состава:

| Наименование параметра | Тип данных | Обязательность | Описание                                                                                            |
|------------------------|------------|----------------|-----------------------------------------------------------------------------------------------------|
| extended_result        | String     | да             | Расширенный результат верификации, содержащий степени схожести (общая и по каждой из модальностей). |

Параметр передается в формате JWT токена:

JWT состоит из трёх частей, разделённых точкой, и имеет следующий вид: HEADER.PAYLOAD.SIGNATURE. Каждая из частей токена
представляет собой значение, закодированное в URL safe Base64.
JWT.HEADER - описание свойств токена, в том числе описание используемого алгоритма для подписи;
JWT.PAYLOAD – непосредственно данные (состав в таблице ниже);
JWT.SIGNATURE - подпись запроса.

Состав JWT.PAYLOAD:

| Наименование параметра | Тип данных  | Обязательность | Описание                                                                                   |
|------------------------|-------------|----------------|--------------------------------------------------------------------------------------------|
| iss                    | String      | да             | Идентификатор организации, выпустившей токен. В данном случае ЕБС: "http:ebs-fr.rtlabs.ru" |
| sub                    | String      | да             | Идентификатор УЗ пользователя в IDP                                                        |
| aud                    | String      | да             | Мнемоника ИС Потребителя БДн                                                               |
| nbf                    | Number      | да             | Время в формате Unix Time, ранее которого нельзя использовать токен                        |
| iat                    | Number      | да             | Время в формате Unix Time, определяющее момент, когда токен был создан                     |
| exp                    | Number      | да             | Время в формате Unix Time, определяющее момент, когда токен станет не валидным             |
| result                 | String      | да             | Результат биометрической верификации                                                       |
| match                  | JSON Object | да             | Содержит степени схожести (общая и по каждой из модальностей)                              |
| match.overall          | Number      | да             | Суммарная степень схожести.                                                                |
| match.{модальность}    | Number      | да             | Степень схожести по отдельным модальностям.                                                |

Пример ответного JWT.PAYLOAD:

```json
{
  "iss": "http://ebs.rtlabs.ru",
  "sub": 11111111,
  "aud": "aud_value",
  "nbf": 1551940552,
  "iat": 1551940551,
  "exp": 1551941153,
  "result": true,
  "match": {
    "voice": 0.70903534,
    "face": 0.999999022,
    "overall": 0.9999997154365625
  }
}
```

```shell
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
 
{ 
    "extended_result":"{Base64url JWT Token с расширенным результатом верификации}"
}
```

#### *Ошибки метода*

В случае возникновения ошибки при обработке запроса, ЕБС возвращает вызывающей стороне HTTP-код ошибки и описание ошибки
в BODY, согласно таблице ниже.

| Код HTTP ответа | Значение параметра "code" | Описание (параметр "message")  |
|-----------------|---------------------------|--------------------------------|
| 400             | EBS-010302                | Идентификатор сессии не найден |
| 400             | EBS-010303                | Время жизни сессии истекло     |

Пример ответа с ошибкой

```shell
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=UTF-8
    
{
  "code": "EBS-010302",
  "message": "Идентификатор сессии не найден"
}
```

# Сборка jar и запуск

Из-за особенностей работы с cryptopro необходимо собирать jar без зависимостей.

Для сборки jar необходимо выполнить:

```bash
./gradlew build
```

Для сборки зависимостей для проекта необходимо вызвать таску для сбора зависимостей:

```bash
./gradlew copyRuntimeDependencies
```

Для запуска необходима специальная настройка стенда и java csp, для работы с cryptopro.
Пример команды проекта:

```bash
    java -cp clients/verification/build/libs/verification-1.0.1.jar:/home/java-csp-5.0.40424/*:clients/verification/build/jars/* ru.rtlabs.ebs.reference.receiver.client.verification.VerificationMain -c clients/verification/src/main/resources/properties.json -l clients/verification/src/main/resources/logback.xml
```

# Сборка образа

Для сборки docker образа

```bash
./gradlew createDockerBuildContext
```

Таска создаст Dockerfile, с помощью которого можно будет собрать образ с сервисом.

Для контейнера необходимо передать конфигурацию по пути:

```bash
/etc/nbp/reference_resiever/
```

Наименование конфигов и путь до них указаны в gradle.properties

```bash
defaultConfigFilePath=/etc/nbp/reference_resiever/properties.json
defaultLogFilePath=/etc/nbp/reference_resiever/logback.xml
```

Пример сборки контейнера:

```bash
cd reference-receiver/clients/verification/build/docker/Dockerfile
docker build -t reference-receiver-verification . 
```

Пример запуска контейнера:

```bash
docker run -it --rm -v reference-receiver/clients/verification/src/main/resources:/etc/nbp/reference_resiever reference-receiver-verification
```

